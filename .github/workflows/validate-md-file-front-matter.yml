name: Validate md file front matter

on:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install jq

      - name: Validate JSON Front Matter
        run: |
          set +e
          ERRORS=""
          for file in $(find ./blog -name '*.md'); do
            echo "Validating $file"
            FRONTMATTER=$(sed -n '/^{/,/^}/p' "$file")
            # Suppress jq error messages to prevent script from exiting
            echo "$FRONTMATTER" | jq '.' > /dev/null 2>&1
            if [ $? -ne 0 ]; then
              echo "Invalid JSON in $file"
              ERRORS="$ERRORS\nInvalid JSON in $file"
              continue
            fi
            REQUIRED_KEYS=("title" "excerpt" "creation_date")
            for key in "${REQUIRED_KEYS[@]}"; do
              echo "$FRONTMATTER" | jq -e "has(\"$key\")" > /dev/null 2>&1
              if [ $? -ne 0 ]; then
                echo "Missing key '$key' in $file"
                ERRORS="$ERRORS\nMissing key '$key' in $file"
              fi
            done
          done
          if [ -n "$ERRORS" ]; then
            echo -e "Errors found: $ERRORS"
            exit 1
          fi
